# ============================================================================
# Job: Deploy Node Init
# Инициализация деплой ноды: проверка SSH, установка пакетов, настройка SSH
# ============================================================================

deploy_node_init:
  stage: deploy_node_init
  extends:
    - .node_preparation_template
    - .ssh_functions

  dependencies:
    - generate_configs
    - terraform:apply

  script:
    - echo "=========================================="
    - echo "ИНИЦИАЛИЗАЦИЯ ДЕПЛОЙ НОДЫ"
    - echo "=========================================="
    - echo ""
    - echo "Деплой нода - ${DEPLOY_NODE_HOST}"
    - echo "Пользователь - ${DEPLOY_NODE_USER}"
    - echo ""

    # === Проверка SSH доступа с retry ===
    - echo "=== Проверка SSH доступа к деплой ноде ==="
    - |
      # Параметры retry
      MAX_RETRIES=20
      RETRY_INTERVAL=15
      SSH_TIMEOUT=10
      
      # Используем SSH_OPTS из ssh_functions.yml (уже экспортировано)
      
      echo "Настройки проверки подключения:"
      echo "  Максимум попыток: ${MAX_RETRIES}"
      echo "  Интервал между попытками: ${RETRY_INTERVAL}с"
      echo ""
      
      check_ping() {
        ping -c 1 -W 2 ${DEPLOY_NODE_HOST} >/dev/null 2>&1
      }
      
      check_ssh() {
        ssh ${SSH_OPTS} ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} "exit 0" >/dev/null 2>&1
      }
      
      retry_count=0
      ssh_available=false
      
      while [ ${retry_count} -lt ${MAX_RETRIES} ]; do
        retry_count=$((retry_count + 1))
        echo "Попытка ${retry_count}/${MAX_RETRIES}"
        
        if check_ping; then
          echo "  [PING] OK"
          if check_ssh; then
            echo "  [SSH] OK"
            ssh_available=true
            break
          else
            echo "  [SSH] FAILED - сервис еще не запущен"
          fi
        else
          echo "  [PING] FAILED - хост загружается"
        fi
        
        if [ ${retry_count} -lt ${MAX_RETRIES} ]; then
          sleep ${RETRY_INTERVAL}
        fi
      done
      
      echo ""
      if [ "${ssh_available}" = "true" ]; then
        ssh ${SSH_OPTS} ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} "echo 'SSH OK'"
        echo "SSH доступ установлен (попыток: ${retry_count})"
      else
        echo "ОШИБКА: Не удалось подключиться после ${MAX_RETRIES} попыток"
        exit 1
      fi

    - echo ""

    # === Установка необходимых пакетов на деплой ноде ===
    - echo "=== Установка необходимых пакетов на деплой ноде ==="
    - |
       ssh ${SSH_OPTS} \
         root@${DEPLOY_NODE_HOST} bash << 'EOFREMOTE'
       set -e

       echo "--- Проверка версии ОС ---"
       if [ -f /etc/altlinux-release ]; then
         cat /etc/altlinux-release
       else
         echo "WARNING Это не ALT Linux! Файл /etc/altlinux-release не найден"
         cat /etc/os-release 2>/dev/null || echo "Информация об ОС недоступна"
       fi

       echo ""
       echo "--- Обновление списка пакетов ---"
       apt-get update -q || {
         echo "WARNING apt-get update завершился с предупреждениями"
       }

       echo ""
       echo "--- Установка базовых пакетов ---"
       

       echo "Установка PACKAGES"
         apt-get install -y \
          ansible \
          unzip \
          sshpass \
          python3 \
          python3-module-pip \
          git \
          curl \
          wget \
          tree

       echo ""
       echo "--- Проверка установленных версий ---"
       echo "Ansible $(ansible --version 2>&1 | head -1)"
       echo "Python $(python3 --version 2>&1)"
       echo "Git $(git --version 2>&1)"
       echo "Unzip $(unzip -v 2>&1 | head -1)"

       echo ""
       echo "✓ Все необходимые пакеты успешно установлены"
       EOFREMOTE

    - echo ""
    - echo "=========================================="
    - echo "ИНИЦИАЛИЗАЦИЯ ДЕПЛОЙ НОДЫ ЗАВЕРШЕНА"
    - echo "=========================================="
    - echo ""

  artifacts:
    name: "deploy-node-init-${CI_PIPELINE_ID}"
    paths:
      - ${RUNNER_WORKDIR}/
    expire_in: 1 week
